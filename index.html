<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>WebGIS ایران - استان و شهرستان</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: Tahoma; height:100vh; overflow:hidden; }
        .container { display:flex; height:100vh; }
        .info-panel { width:350px; background:#2c3e50; color:white; padding:0; box-shadow:-4px 0 15px rgba(0,0,0,0.4); display:flex; flex-direction:column; }
        .panel-header { background:rgba(0,0,0,0.3); padding:20px; text-align:center; border-bottom:3px solid #3498db; }
        .panel-content { flex:1; padding:20px; overflow-y:auto; }
        .province-info { background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; border-right:4px solid #3498db; }
        .info-item { margin:10px 0; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.2); display:flex; justify-content:space-between; }
        .info-label { opacity:0.8; font-size:0.9em; }
        #map { flex:1; }
        .home-button { position:absolute; top:90px; left:10px; z-index:1000; background:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .home-button:hover { background:#3498db; }
        .home-button:hover svg { fill:white; }
    </style>
</head>
<body>
<div class="container">
    <div class="info-panel">
        <div class="panel-header">
            <h1>نقشه ایران</h1>
            <p>استان → شهرستان</p>
        </div>
        <div class="panel-content" id="infoPanel">
            <div style="text-align:center; padding:50px 20px; opacity:0.7;">
                <div style="font-size:4em;">Map</div>
                <h3>یک استان انتخاب کنید</h3>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<div class="home-button" onclick="zoomToIran()" title="بازگشت">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="#333">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([32.4279, 53.6880], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let provincesLayer = null;
    let countiesLayer = null;
    let selectedProvince = null;
    let countiesData = null;

    // تبدیل Esri rings به GeoJSON coordinates
    function ringsToCoordinates(rings) {
        return rings.map(ring => ring.map(coord => [coord[0], coord[1]]));
    }

    // تبدیل Esri JSON به GeoJSON استاندارد
    function esriToGeoJSON(esriData) {
        return {
            type: "FeatureCollection",
            features: esriData.features.map(f => ({
                type: "Feature",
                properties: f.attributes,
                geometry: {
                    type: "Polygon",
                    coordinates: ringsToCoordinates(f.geometry.rings)
                }
            }))
        };
    }

    // بارگذاری استان‌ها
    fetch('ir.json')
        .then(r => r.json())
        .then(data => {
            provincesLayer = L.geoJSON(data, {
                style: { color: "#2980b9", weight: 2, fillColor: "#3498db", fillOpacity: 0.4 },
                onEachFeature: (feature, layer) => {
                    const name = feature.properties.name;
                    layer.bindTooltip(name, { direction: "center" });

                    layer.on('click', () => {
                        if (selectedProvince) provincesLayer.resetStyle(selectedProvince);
                        selectedProvince = layer;
                        layer.setStyle({ weight: 4, color: "#1f4788", fillColor: "#1f4788", fillOpacity: 0.7 });
                        map.fitBounds(layer.getBounds(), { padding: [30,30] });

                        showCounties(name);
                    });
                }
            }).addTo(map);
        });

    // بارگذاری و تبدیل شهرستان‌ها
    fetch('counties.json')
        .then(r => r.json())
        .then(esriData => {
            countiesData = esriToGeoJSON(esriData);
            console.log("شهرستان‌ها با موفقیت تبدیل و بارگذاری شدند:", countiesData.features.length);
        });

    const provinceNameMap = {
        "چهارمحال و بختیاری": "چهارمحال وبختیاری",
        "کهگیلویه و بویراحمد": "کهکیلویه و بویراحمد",
        "چهارمحال وبختیاری": "چهارمحال وبختیاری",
        "کهکیلویه و بویراحمد": "کهکیلویه و بویراحمد"
    };

    function showCounties(provinceName) {
        if (!countiesData) {
            setTimeout(() => showCounties(provinceName), 500);
            return;
        }

        if (countiesLayer) map.removeLayer(countiesLayer);

        const targetName = provinceNameMap[provinceName] || provinceName;

        const filtered = countiesData.features.filter(f => 
            f.properties.pname === targetName
        );

        if (filtered.length === 0) {
            document.getElementById('infoPanel').innerHTML = `<div class="province-info"><h3>${provinceName}</h3><p style="color:#e74c3c">شهرستان یافت نشد (pname: "${targetName}")</p></div>`;
            return;
        }

        countiesLayer = L.geoJSON(filtered, {
            style: { color: "#e67e22", weight: 2.5, fillColor: "#f39c12", fillOpacity: 0.6 },
            onEachFeature: (f, layer) => {
                const p = f.properties;
                layer.bindTooltip(p.Name, { direction: "center" });
                layer.on('click', () => {
                    map.fitBounds(layer.getBounds(), { padding: [40,40] });
                    document.getElementById('infoPanel').innerHTML = `
                        <div class="province-info">
                            <h3>${p.Name}</h3>
                            <div class="info-item"><span class="info-label">استان:</span><span>${provinceName}</span></div>
                            <div class="info-item"><span class="info-label">مرکز:</span><span>${p.ccenter_na || "-"}</span></div>
                        </div>`;
                });
            }
        }).addTo(map);

        map.fitBounds(countiesLayer.getBounds(), { padding: [50,50] });

        document.getElementById('infoPanel').innerHTML = `
            <div class="province-info">
                <h3>استان ${provinceName}</h3>
                <p>${filtered.length} شهرستان</p>
            </div>`;
    }

    function zoomToIran() {
        map.setView([32.4279, 53.6880], 5);
        if (selectedProvince) { provincesLayer.resetStyle(selectedProvince); selectedProvince = null; }
        if (countiesLayer) { map.removeLayer(countiesLayer); countiesLayer = null; }
        document.getElementById('infoPanel').innerHTML = `<div style="text-align:center;padding:50px;opacity:0.7"><div style="font-size:4em;">Map</div><h3>یک استان انتخاب کنید</h3></div>`;
    }
</script>
</body>
</html>
